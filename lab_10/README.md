# Лабораторная работа 10.

## Цели работы

1. Настроить iBGP в офисе Москва.
2. Настроить iBGP в сети провайдера Триада.
3. Организовать полную IP связанность всех сетей.

## Задачи

1. Настроить iBGP в офисе Москва между маршрутизаторами R14 и R15.
2. Настроить iBGP в провайдере Триада.
3. Настроить офис Москва так, чтобы приоритетным провайдером стал Ламас.
4. Настроить офис С.-Петербург так, чтобы трафик до любого офиса распределялся по двум линкам одновременно.
5. Все сети в лабораторной работе должны иметь IP связность.

## План работ

1. Настроить iBGP в офисе Москва между маршрутизаторами R14 и R15.
2. Настроить iBGP в провайдере Триада.
3. Установить провайдера Ламас как приоритетного на площадке Москва.
4. Настроить распределение трафика с площадки С.-Петербург.
5. Проверить связность в сети.

--- 
 
**Рис. 1. - Общая схема сети.**

![Схема сети](l10.png)

---

Все конфигурационные файлы расположены в каталоге [cfg](./cfg/).

---

#### Изменения в топологии в последующих работах.

Не зафиксировано.

---

#### Изменения в топологии по отношению к предыдущим работам.

1. На площадках: Ламас, Киторн, Триада была выполнена заготовка фильтрации, а именно:
    * Cоздан access-list, разрешающий только адреса 10.255.0.0/24
    * Создан peer-policy template для bgp, несущий в себе ограничение по distribute-list out c указанием access-list`а. 
    * Данный шаблон был назначен всем внешним соседям устройств на указанных площадках.

---

## Выполнение

### Настроить iBGP в офисе Москва между маршрутизаторами R14 и R15.

1. Согласно [изменениям в топологии](../lab_9/) из лабораторной работы №9, а также разделу "Настройка BGP на маршрутизаторах" той же лабораторной работы, на площадке Москва уже настроен iBGP между R14 и R15.

### Настроить iBGP в провайдере Триада.

Также, согласно предыдущей работе, на площадке Триада уже был настроен iBGP. В рамках данной работы произведем реконфигурацию под использование route-reflector. Сервером в данном случае будет выступать R25.

1. Убираем все отношения соседства с AS520 на всех маршрутизаторах площадки.
2. Создаем шаблон для iBGP сессии, параметры аналогичны предыдущим настройкам.

        template peer-session <T_S_POL_NAME>
          remote-as 520
          update-source Loopback0
          
    Где `T_S_POL_NAME` - наименование создаваемой политики для сессии.
          
3. Создаем шаблон для iBGP пира. Указываем что пиры в данной группе будут являться клиентами route-reflector`а.

        template peer-policy <T_P_POL_NAME>
          route-reflector-client
          
    Где `T_P_POL_NAME` - наименование создаваемой политики для пира.

4. Возвращаем всех соседей (R23, R24, R26) с указанием наследования обоих шаблонов.

    > Сначала указываем наследование peer-session, чтобы первой командой подтянулся атрибут remote-as, иначе сосед не будет принят.

        neighbor <IP_NEIGH> inherit peer-session <T_S_POL_NAME>
        neighbor <IP_NEIGH> inherit peer-policy <T_P_POL_NAME>
        
    Где `IP_NEIGH` - адреса loopback-интерфейсов клиентов route-reflector.

5. На "клиентах" (R23, R24, R26) настраиваем шаблон peer-session и устанавливаем соседство только с R25 (`IP_ADDR_RR_SRV` - адрес loopback интерфейса R25, `T_S_POL_NAME_CL` - имя создаваемой политики для сессии):

        template peer-session <T_S_POL_NAME_CL>
        remote-as 520
        update-source Loopback0

        neighbor <IP_ADDR_RR_SRV> inherit peer-session <T_S_POL_NAME_CL>
        
### Установить провайдера Ламас как приоритетного на площадке Москва.

Данное изменение выполняем посредством настройки атрибута local preference на R15.

1. Создаем route-map для изменения параметра:

        route-map <ROUTE_MAP_NAME> permit 10
          set local-preference <VAL>
          
    Где:
    * `ROUTE_MAP_NAME` - имя префикс-листа
    * `VAL` - новое значение для атрибута local preference (стандартное - 100, соответственно новое должно быть выше)
    
2. Указываем данный route-map для соседа, на входящее направление:

        neighbor <IP_NEIGH> route-map <ROUTE_MAP_NAME> in
        
    Где `IP_NEIGH` - адрес маршрутизатора площадки Ламас.
    
3. Аналогичное делаем для R14, но в качестве `IP_NEIGH` указываем адрес маршрутизатора Киторн, а значение `VAL` указываем меньшее, чем было настроено в R15.

4. Пробуем с R14 выполнть трассировку до R23 (кратчайший путь до которого - через R22 \[Киторн\]):

        R14#traceroute 10.255.0.29
        Type escape sequence to abort.
        Tracing the route to 10.255.0.29
        VRF info: (vrf in name/id, vrf out name/id)
        1 10.255.0.51 1 msec 1 msec 0 msec
        2 10.255.0.13 3 msec 1 msec 1 msec
        3 10.255.0.25 [AS 301] 1 msec 1 msec 0 msec
        4 10.255.0.29 [AS 101] 1 msec *  2 msec

    Таким образом, видим что трафик, пусть он все равно пошел через Киторн, изначально с площадки был передан в сторону AS301 (Ламас).

### Настроить распределение трафика с площадки С.-Петербург.

1. Перед выполнением работ, выполняем трассировку с R18 до удаленной площадки (Киторн):

        R18#traceroute 10.255.0.28
        Type escape sequence to abort.
        Tracing the route to 10.255.0.28
        VRF info: (vrf in name/id, vrf out name/id)
        1 10.255.0.21 [AS 520] 1 msec 0 msec 5 msec
        2 10.255.0.30 [AS 520] 1 msec 0 msec 1 msec
        3 10.255.0.28 [AS 520] 1 msec *  1 msec

    Видим, что трафик идет строго через R24 (10.255.0.21)
        
2. Переходим в режим конфигурации BGP, указываем атрибут `maximum-paths 2`.
3. Повторяем трассировку:

        R18#traceroute 10.255.0.28
        Type escape sequence to abort.
        Tracing the route to 10.255.0.28
        VRF info: (vrf in name/id, vrf out name/id)
        1 10.255.0.21 [AS 520] 2 msec
            10.255.0.23 [AS 520] 1 msec
            10.255.0.21 [AS 520] 0 msec
        2 10.255.0.36 [AS 520] 1 msec
            10.255.0.30 [AS 520] 1 msec
            10.255.0.36 [AS 520] 1 msec
        3 10.255.0.28 [AS 520] 1 msec
            10.255.0.32 [AS 520] 1 msec * 
            
    Видим, что теперь трафик идет помимо R24, также и через R26 (10.255.0.23).
    
### Проверить связность в сети.

1. Проверка доступности R28 (Чокурдах) с VPC1 (Москва):
    
        VPCS> trace 10.255.0.45
        trace to 10.255.0.45, 8 hops max, press Ctrl+C to stop
        1   10.1.10.1   1.535 ms  0.756 ms  0.779 ms
        2   10.255.0.3   3.707 ms  1.216 ms  0.862 ms
        3   10.255.0.13   2.212 ms  1.085 ms  1.627 ms
        4   10.255.0.27   1.568 ms  1.651 ms  1.182 ms
        5   10.255.0.35   2.198 ms  1.178 ms  1.491 ms
        6   *10.255.0.45   2.845 ms (ICMP type:3, code:3, Destination port unreachable)  *

2. Проверка доступности R22 (Киторн) с R28 (Чокурдах).

        R28#traceroute 10.255.0.28
        Type escape sequence to abort.
        Tracing the route to 10.255.0.28
        VRF info: (vrf in name/id, vrf out name/id)
        1 10.255.0.40 2 msec 0 msec 0 msec
        2 10.255.0.32 1 msec 1 msec 0 msec
        3 10.255.0.28 1 msec *  2 msec

3. Проверка доступности R27 (Лабытнанги) с VPC8 (С.-Петербург)

        VPCS> trace 10.255.0.39
        trace to 10.255.0.39, 8 hops max, press Ctrl+C to stop
        1   10.2.20.1   0.621 ms  0.439 ms  0.419 ms
        2   10.255.0.19   1.360 ms  0.771 ms  1.010 ms
        3   10.255.0.21   2.171 ms  0.795 ms  0.872 ms
        4   10.255.0.35   2.072 ms  1.049 ms  1.014 ms
        5   10.255.0.36   1.937 ms  5.054 ms  1.953 ms
        6   *10.255.0.39   4.772 ms (ICMP type:3, code:3, Destination port unreachable)  *

Исходя из данных результатов можем сделать вывод о наличии связности в сети.
